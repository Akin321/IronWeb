pipeline {
    agent any

    environment {
        JAR_NAME = "Iron-0.0.1-SNAPSHOT.jar"
        EC2_USER = "ec2-user"
        EC2_HOST = "13.201.157.44"
        EC2_PATH = "/home/ec2-user/"
        PEM_PATH = "C:/Users/HP/Downloads/ironkeypair.pem"
    }

    stages {
        stage('Checkout') {
            steps {
                git url: 'https://github.com/Akin321/IronWeb.git'
            }
        }

        stage('Build') {
            steps {
                sh './mvnw clean package -DskipTests'
            }
        }

        stage('Deploy to EC2') {
            steps {
                sh """
                    scp -i $PEM_PATH target/$JAR_NAME $EC2_USER@$EC2_HOST:$EC2_PATH
                    ssh -i $PEM_PATH $EC2_USER@$EC2_HOST 'pkill -f $JAR_NAME || true && nohup java -jar $JAR_NAME > app.log 2>&1 &'
                """
            }
        }
    }
}
