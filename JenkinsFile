pipeline {
  agent any
  options {
    timeout(time: 5, unit: 'MINUTES')
  }

  stages {
    stage('Clone') {
      steps {
        git url: 'https://github.com/Akin321/IronWeb.git', branch: 'main'
      }
    }

    stage('Build') {
      steps {
        sh 'mvn clean package -DskipTests'
      }
    }

    stage('Deploy') {
      steps {
        sshagent(['0cb6fa5e-b06b-46ee-af98-a518fdf5e187']) {
          sh '''
          echo "Copying JAR to EC2..."
          scp -o StrictHostKeyChecking=no target/Iron-1.0.0.jar ubuntu@51.21.243.15:/home/ubuntu/Iron.jar || { echo "SCP failed"; exit 1; }

          echo "Killing existing Java processes..."
          ssh -o StrictHostKeyChecking=no ubuntu@51.21.243.15 'pkill -f "java -jar" || echo "No process to kill"'

          echo "Starting new Spring Boot app..."
          ssh -o StrictHostKeyChecking=no ubuntu@51.21.243.15 'nohup java -jar /home/ubuntu/Iron.jar > Iron.log 2>&1 &' || { echo "App failed to start"; exit 1; }
          '''
        }
      }
    }
  }
}
